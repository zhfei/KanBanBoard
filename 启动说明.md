# 项目启动说明

## 快速启动

在项目根目录执行：

```bash
docker compose up
```

启动后访问：
- 前端：http://localhost:3000
- 后端 API：http://localhost:8080
- 数据库：localhost:5432

### 服务启动顺序

`docker compose up` 会按以下顺序启动服务：

1. **kanban-db** - PostgreSQL 数据库服务
   - 等待数据库健康检查通过

2. **kanban-migrate** - 数据库迁移服务
   - 等待数据库就绪后执行迁移脚本
   - 执行完成后自动退出（`restart: "no"`）
   - 迁移脚本位置：`backend/migrations/init.sql`

3. **kanban-backend** - 后端 API 服务
   - 等待迁移服务成功完成后启动
   - 提供 REST API 接口

4. **kanban-frontend** - 前端 Web 服务
   - 等待后端服务启动后启动
   - 提供 Web 界面

### 验证迁移服务

迁移服务（kanban-migrate）会在启动时自动执行，你可以通过以下方式验证：

```bash
# 查看迁移服务日志
docker compose logs migrate

# 应该看到类似输出：
# [Migration] Waiting for database to be ready...
# [Migration] Database is ready
# [Migration] Running migrations...
# [Migration] Starting database initialization...
# [Migration] Creating tasks table...
# [Migration] Creating index on status...
# [Migration] Adding status constraint...
# [Migration] Database initialization completed successfully!
# Migrations completed successfully
```

如果迁移失败，后端服务将不会启动（因为 backend 依赖于 migrate 的成功完成）。

### 首次启动前（可选但推荐）

为了确保依赖版本一致性，建议生成 `package-lock.json` 文件：

```bash
# 生成前端 package-lock.json
cd frontend
npm install
cd ..

# 生成后端 package-lock.json
cd backend
npm install
cd ..
```

生成后，可以修改 Dockerfile 将 `npm install` 改回 `npm ci`（更快且更可靠）。

## 常见问题解决

### 1. Docker 镜像拉取超时

如果遇到 `failed to resolve reference` 或 `context deadline exceeded` 错误，可能是网络连接问题。

#### 解决方案 A：配置 Docker 镜像加速器（推荐）

**macOS / Windows (Docker Desktop):**
1. 打开 Docker Desktop
2. 进入 Settings → Docker Engine
3. 添加以下配置：

```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

4. 点击 "Apply & Restart"

**Linux:**
编辑 `/etc/docker/daemon.json`：

```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

然后重启 Docker：
```bash
sudo systemctl restart docker
```

#### 解决方案 B：手动拉取镜像

```bash
# 拉取 PostgreSQL 镜像
docker pull postgres:16-alpine

# 拉取 Node.js 镜像（如果需要）
docker pull node:20-alpine

# 拉取 Nginx 镜像（如果需要）
docker pull nginx:1.25-alpine
```

#### 解决方案 C：使用代理

如果使用代理，配置 Docker 代理：

**macOS / Windows (Docker Desktop):**
Settings → Resources → Proxies → 配置代理

**Linux:**
创建 `/etc/systemd/system/docker.service.d/http-proxy.conf`：

```ini
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080"
Environment="HTTPS_PROXY=http://proxy.example.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1"
```

然后重启：
```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 2. 端口冲突

如果端口被占用，可以修改 `docker-compose.yml` 中的端口映射：

```yaml
services:
  frontend:
    ports:
      - "3001:80"  # 改为其他端口
  backend:
    ports:
      - "8081:8080"  # 改为其他端口
  db:
    ports:
      - "5433:5432"  # 改为其他端口
```

### 3. 权限问题（Linux）

如果遇到权限问题，确保当前用户在 docker 组中：

```bash
sudo usermod -aG docker $USER
# 重新登录或执行
newgrp docker
```

### 4. 清理和重建

如果遇到构建问题，可以清理后重新构建：

```bash
# 停止并删除容器
docker compose down

# 删除镜像（可选）
docker compose down --rmi all

# 清理未使用的资源
docker system prune -a

# 重新构建并启动
docker compose up --build
```

## 验证启动成功

### 1. 检查容器状态

```bash
docker compose ps
```

应该看到：
- kanban-db - 状态为 `running`
- kanban-migrate - 状态为 `exited`（正常，迁移完成后自动退出）
- kanban-backend - 状态为 `running`
- kanban-frontend - 状态为 `running`

**注意**：`kanban-migrate` 的状态为 `exited` 是正常的，因为它是一个一次性任务，执行完数据库迁移后就会退出。

### 2. 检查日志

```bash
# 查看所有服务日志
docker compose logs

# 查看特定服务日志
docker compose logs backend
docker compose logs frontend
docker compose logs db
```

### 3. 测试 API

```bash
# 测试健康检查
curl http://localhost:8080/health

# 测试获取任务列表
curl http://localhost:8080/api/tasks
```

### 4. 访问前端

打开浏览器访问：http://localhost:3000

应该能看到看板界面，包含三列：待办、进行中、已完成。

## 停止服务

```bash
# 停止服务（保留数据）
docker compose stop

# 停止并删除容器（保留数据卷）
docker compose down

# 停止并删除所有（包括数据卷）
docker compose down -v
```

## 开发模式

### 前端开发

```bash
cd frontend
npm install
npm run dev
```

前端将在 http://localhost:5173 启动（Vite 默认端口）

### 后端开发

```bash
cd backend
npm install
npm run prisma:generate
npm run dev
```

后端将在 http://localhost:8080 启动

**注意：** 开发模式下需要确保数据库已启动：
```bash
docker compose up db
```
